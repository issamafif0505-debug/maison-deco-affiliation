---
import { formatPrice } from '../../utils/formatting';
import { buildAmazonLink } from '../../utils/affiliate';
import RatingStars from './RatingStars.astro';

interface Props {
  name: string;
  slug: string;
  shortDescription: string;
  image: string;
  category: string;
  amazonAsin?: string;
  affiliateTag?: string;
  price: { current: number; currency: string };
  rating: { score: number; count: number };
  featured?: boolean;
  inStock?: boolean;
}

const {
  name, slug, shortDescription, image, category,
  amazonAsin, affiliateTag = 'issamdeco-21',
  price, rating, featured = false, inStock = true,
} = Astro.props;

const amazonUrl = amazonAsin ? buildAmazonLink(amazonAsin, affiliateTag) : null;
---

<article class="card group relative flex flex-col h-full">
  <!-- Badges -->
  <div class="absolute top-3 left-3 z-10 flex flex-col gap-1">
    {featured && (
      <span class="badge-hot text-xs">⭐ Coup de cœur</span>
    )}
  </div>
  {!inStock && (
    <div class="absolute top-3 right-3 z-10">
      <span class="inline-flex items-center bg-gray-500/90 text-white px-2 py-0.5 rounded-full text-xs font-bold">Indisponible</span>
    </div>
  )}

  <!-- Image — clique vers la fiche -->
  <a href={`/produits/${slug}/`} class="block flex-shrink-0">
    <div class="aspect-[4/3] bg-gray-50 flex items-center justify-center p-5 overflow-hidden">
      <img
        src={image}
        alt={name}
        class="max-w-full max-h-full object-contain group-hover:scale-105 transition-transform duration-300"
        loading="lazy"
      />
    </div>
  </a>

  <!-- Contenu -->
  <div class="p-4 flex flex-col flex-1">
    <a href={`/produits/${slug}/`} class="block flex-1">
      <span class="badge-category text-xs capitalize mb-2 inline-block">{category}</span>
      <h3 class="font-serif font-bold text-gray-900 group-hover:text-primary-600 transition-colors mb-1 line-clamp-2 text-[15px] leading-snug">
        {name}
      </h3>
      <p class="text-xs text-gray-500 line-clamp-2 mb-3 leading-relaxed">{shortDescription}</p>

      <!-- Rating -->
      <div class="flex items-center gap-1.5 mb-3">
        <RatingStars score={rating.score} />
        <span class="text-xs text-gray-500">
          {rating.score}/5
          <span class="text-gray-400">({rating.count.toLocaleString('fr-FR')})</span>
        </span>
      </div>

      <!-- Prix + livraison -->
      <div class="flex items-end justify-between mb-4">
        <span class="text-2xl font-bold text-gray-900">
          {formatPrice(price.current, price.currency)}
        </span>
        <span class="text-xs text-green-600 font-semibold flex items-center gap-1 pb-0.5">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
          Livraison rapide
        </span>
      </div>
    </a>

    <!-- Bouton Amazon -->
    {amazonUrl ? (
      <a
        href={amazonUrl}
        target="_blank"
        rel="nofollow sponsored noopener"
        class="btn-amazon-card"
        aria-label={`Voir ${name} sur Amazon`}
      >
        <svg class="w-4 h-4 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M13.958 10.09c0 1.232.029 2.256-.591 3.351-.502.891-1.301 1.438-2.186 1.438-1.214 0-1.922-.924-1.922-2.292 0-2.692 2.415-3.182 4.699-3.182v.685zm3.186 7.705c-.209.189-.512.201-.745.074-1.052-.872-1.238-1.276-1.814-2.106-1.734 1.767-2.962 2.297-5.209 2.297-2.66 0-4.731-1.641-4.731-4.925 0-2.565 1.391-4.309 3.37-5.164 1.715-.754 4.11-.891 5.942-1.097v-.41c0-.753.06-1.642-.384-2.294-.385-.579-1.124-.82-1.775-.82-1.205 0-2.277.618-2.54 1.898-.054.285-.261.567-.547.582l-3.065-.331c-.259-.056-.545-.27-.472-.669.704-3.716 4.06-4.838 7.066-4.838 1.537 0 3.547.41 4.758 1.574 1.538 1.436 1.391 3.352 1.391 5.438v4.923c0 1.479.616 2.13 1.192 2.929.204.287.249.63-.012.844-.647.541-1.794 1.537-2.425 2.095l-.001-.001z"/>
        </svg>
        <span>Voir le prix sur Amazon</span>
        <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
        </svg>
      </a>
    ) : (
      <a href={`/produits/${slug}/`} class="btn-amazon-card">
        Voir le produit →
      </a>
    )}
  </div>
</article>
