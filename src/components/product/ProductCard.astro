---
import { formatPrice } from '../../utils/formatting';
import RatingStars from './RatingStars.astro';

interface Props {
  name: string;
  slug: string;
  shortDescription: string;
  image: string;
  category: string;
  price: { current: number; currency: string };
  rating: { score: number; count: number };
  featured?: boolean;
  bestseller?: boolean;
  inStock?: boolean;
}

const { name, slug, shortDescription, image, category, price, rating, featured = false, bestseller = false, inStock = true } = Astro.props;

function formatCount(count: number): string {
  if (count >= 1000) {
    return (count / 1000).toFixed(count >= 10000 ? 0 : 1) + 'k';
  }
  return count.toString();
}
---

<article class="card group relative flex flex-col h-full hover:-translate-y-1 transition-all duration-300">
  <!-- Badges -->
  <div class="absolute top-3 left-3 z-10 flex flex-col gap-1">
    {bestseller && (
      <span class="inline-flex items-center gap-1 bg-amber-500 text-white text-xs font-bold px-2.5 py-1 rounded-full shadow-sm">
        üèÜ Bestseller
      </span>
    )}
    {featured && (
      <span class="inline-flex items-center gap-1 bg-primary-600 text-white text-xs font-bold px-2.5 py-1 rounded-full shadow-sm">
        ‚≠ê Coup de c≈ìur
      </span>
    )}
  </div>

  {!inStock && (
    <div class="absolute top-3 right-3 z-10">
      <span class="bg-red-100 text-red-600 text-xs font-medium px-2 py-0.5 rounded-full">Indisponible</span>
    </div>
  )}

  <a href={`/produits/${slug}/`} class="block flex-1 flex flex-col">
    <!-- Image -->
    <div class="aspect-square bg-gray-50 flex items-center justify-center p-6 overflow-hidden">
      <img
        src={image}
        alt={`${name} - avis et prix Amazon`}
        class="max-w-full max-h-full object-contain group-hover:scale-105 transition-transform duration-500"
        loading="lazy"
        onerror="this.src='/favicon.svg'"
        width="300"
        height="300"
      />
    </div>

    <!-- Content -->
    <div class="p-4 flex flex-col flex-1 border-t border-gray-50">
      <span class="badge-category text-xs capitalize mb-2 inline-block w-fit">{category}</span>
      <h3 class="font-serif font-bold text-gray-900 group-hover:text-primary-600 transition-colors mb-1.5 line-clamp-2 text-sm leading-snug flex-1">
        {name}
      </h3>
      <p class="text-xs text-gray-500 line-clamp-2 mb-3 leading-relaxed">{shortDescription}</p>

      <!-- Rating -->
      <div class="flex items-center gap-1.5 mb-3">
        <RatingStars score={rating.score} />
        <span class="text-xs font-semibold text-gray-700">{rating.score}</span>
        <span class="text-xs text-gray-400">({formatCount(rating.count)})</span>
      </div>

      <!-- Prix & stock -->
      <div class="flex items-center justify-between mt-auto pt-2.5 border-t border-gray-100">
        <span class="text-lg font-bold text-gray-900">
          {formatPrice(price.current, price.currency)}
        </span>
        {inStock ? (
          <span class="text-xs text-green-600 font-medium flex items-center gap-1">
            <span class="w-1.5 h-1.5 bg-green-500 rounded-full inline-block"></span>
            En stock
          </span>
        ) : (
          <span class="text-xs text-red-500 font-medium">Indisponible</span>
        )}
      </div>
    </div>
  </a>

  <!-- CTA -->
  <div class="px-4 pb-4 pt-2">
    <a
      href={`/produits/${slug}/`}
      class="w-full block text-center bg-amber-400 hover:bg-amber-500 text-gray-900 font-bold text-sm py-2.5 rounded-xl transition-all duration-200 hover:shadow-md"
    >
      Voir le prix Amazon ‚Üí
    </a>
    <p class="text-center text-xs text-gray-400 mt-1.5 flex items-center justify-center gap-1">
      <span>üì¶</span> Livraison Prime 24h disponible
    </p>
  </div>
</article>
