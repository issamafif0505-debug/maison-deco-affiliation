---
import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '../components/common/Breadcrumbs.astro';
import AmazonButton from '../components/product/AmazonButton.astro';
import RatingStars from '../components/product/RatingStars.astro';
import ProsCons from '../components/product/ProsCons.astro';
import { formatPrice } from '../utils/formatting';
import { productSchema } from '../utils/seo';
import { buildAmazonLink } from '../utils/affiliate';
import siteConfig from '../data/site-config.json';

interface Props {
  name: string;
  slug: string;
  shortDescription: string;
  fullDescription: string;
  category: string;
  amazonAsin: string;
  affiliateTag: string;
  price: { current: number; currency: string; lastChecked: string };
  rating: { score: number; count: number };
  image: string;
  images?: string[];
  videoUrl?: string;
  pros: string[];
  cons: string[];
  specifications: { label: string; value: string }[];
  featured: boolean;
  inStock: boolean;
}

const props = Astro.props;
const allImages = [props.image, ...(props.images || [])];

const breadcrumbs = [
  { label: 'Produits', href: '/produits/' },
  { label: props.name },
];

const schema = productSchema({
  name: props.name,
  description: props.shortDescription,
  image: props.image,
  price: props.price.current,
  currency: props.price.currency,
  rating: props.rating.score,
  ratingCount: props.rating.count,
  inStock: props.inStock,
  url: new URL(`/produits/${props.slug}/`, siteConfig.siteUrl).toString(),
});
---

<BaseLayout
  title={props.name}
  description={props.shortDescription}
  image={props.image}
  schema={schema}
>
  <div class="container-custom py-8 md:py-12">
    <Breadcrumbs items={breadcrumbs} />

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 mb-12">
      <!-- Product Images Gallery -->
      <div>
        <div class="aspect-square bg-white rounded-2xl shadow-sm border border-gray-100 flex items-center justify-center p-8 mb-3">
          <img
            id="main-product-image"
            src={props.image}
            alt={props.name}
            class="max-w-full max-h-full object-contain"
            loading="eager"
          />
        </div>
        {allImages.length > 1 && (
          <div class="flex gap-2 overflow-x-auto pb-2">
            {allImages.map((img, i) => (
              <button
                class:list={["flex-shrink-0 w-16 h-16 rounded-lg border-2 overflow-hidden cursor-pointer bg-white p-1", i === 0 ? "border-primary-500" : "border-gray-200 hover:border-gray-400"]}
                data-image-url={img}
                onclick="document.getElementById('main-product-image').src=this.dataset.imageUrl; document.querySelectorAll('[data-image-url]').forEach(b=>b.classList.replace('border-primary-500','border-gray-200')); this.classList.replace('border-gray-200','border-primary-500');"
              >
                <img src={img} alt={`${props.name} - vue ${i + 1}`} class="w-full h-full object-contain" loading="lazy" />
              </button>
            ))}
          </div>
        )}
        {props.videoUrl && (
          <div class="mt-4 rounded-2xl overflow-hidden shadow-sm border border-gray-100">
            <div class="aspect-video">
              <iframe
                src={props.videoUrl}
                title={`Vidéo - ${props.name}`}
                class="w-full h-full"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
              ></iframe>
            </div>
          </div>
        )}
      </div>

      <!-- Product Info -->
      <div class="flex flex-col justify-start">
        <!-- Badges -->
        <div class="flex flex-wrap gap-2 mb-4">
          <span class="badge-category capitalize">{props.category}</span>
          {props.featured && <span class="badge bg-amber-100 text-amber-700">⭐ Coup de cœur</span>}
          {!props.inStock && <span class="badge bg-red-100 text-red-700">Indisponible</span>}
        </div>

        <h1 class="font-serif text-3xl md:text-4xl font-bold text-gray-900 mb-3 leading-snug">
          {props.name}
        </h1>

        <p class="text-gray-600 text-base mb-4 leading-relaxed">{props.shortDescription}</p>

        <!-- Rating + avis -->
        <div class="flex items-center gap-3 mb-5 pb-5 border-b border-gray-100">
          <RatingStars score={props.rating.score} />
          <span class="text-sm font-semibold text-gray-700">{props.rating.score}/5</span>
          <span class="text-sm text-gray-400">·</span>
          <span class="text-sm text-gray-500">{props.rating.count.toLocaleString('fr-FR')} avis Amazon</span>
        </div>

        <!-- Prix -->
        <div class="mb-5">
          <div class="flex items-baseline gap-3 mb-1">
            <span class="text-4xl font-bold text-gray-900">
              {formatPrice(props.price.current, props.price.currency)}
            </span>
          </div>
          <div class="flex items-center gap-4 text-sm">
            <span class="flex items-center gap-1 text-green-600 font-semibold">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
              Livraison rapide Amazon
            </span>
            <span class="text-gray-400">·</span>
            <span class="text-gray-500">Prix vérifié le {props.price.lastChecked}</span>
          </div>
        </div>

        <!-- CTA principal -->
        <div class="mb-4">
          <AmazonButton asin={props.amazonAsin} tag={props.affiliateTag} size="large" />
        </div>

        <!-- Social proof micro -->
        <div class="flex items-center gap-2 text-xs text-gray-500 mb-6">
          <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
          Paiement sécurisé Amazon · Retour gratuit 30 jours
        </div>

        <!-- Pros & Cons -->
        <ProsCons pros={props.pros} cons={props.cons} />
      </div>
    </div>

    <!-- Full Description -->
    <div class="max-w-3xl mx-auto mb-12">
      <h2 class="font-serif text-2xl font-bold text-gray-900 mb-4">Notre avis détaillé</h2>
      <div class="prose-custom">
        <p>{props.fullDescription}</p>
      </div>
    </div>

    <!-- Specifications -->
    {props.specifications.length > 0 && (
      <div class="max-w-3xl mx-auto mb-12">
        <h2 class="font-serif text-2xl font-bold text-gray-900 mb-4">Caractéristiques techniques</h2>
        <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm">
          <table class="w-full">
            <tbody>
              {props.specifications.map((spec, index) => (
                <tr class:list={[index % 2 === 0 ? 'bg-gray-50' : 'bg-white']}>
                  <td class="px-6 py-3.5 text-sm font-semibold text-gray-700 w-1/3">{spec.label}</td>
                  <td class="px-6 py-3.5 text-sm text-gray-600">{spec.value}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    )}

    <!-- Bottom CTA -->
    <div class="max-w-3xl mx-auto text-center p-8 rounded-2xl mb-8" style="background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); border: 1px solid #fed7aa;">
      <h3 class="font-serif text-xl font-bold text-gray-900 mb-2">Intéressé(e) par ce produit ?</h3>
      <p class="text-gray-600 mb-2">Consultez le prix actuel et les avis sur Amazon.fr</p>
      <p class="text-xs text-gray-400 mb-5">Retour gratuit 30 jours · Livraison Prime disponible</p>
      <AmazonButton asin={props.amazonAsin} tag={props.affiliateTag} size="large" />
    </div>

    <!-- Disclaimer -->
    <p class="text-xs text-gray-400 text-center max-w-2xl mx-auto">
      En tant que Partenaire Amazon, je perçois une commission sur les achats qualifiés. Cela ne change pas le prix que vous payez.
    </p>
  </div>

  <!-- Sticky mobile CTA -->
  <div class="fixed bottom-0 left-0 right-0 z-40 md:hidden bg-white border-t border-gray-200 shadow-2xl p-3">
    <div class="flex items-center gap-3 max-w-sm mx-auto">
      <div class="flex-1 min-w-0">
        <p class="text-xs font-semibold text-gray-900 truncate">{props.name}</p>
        <p class="text-base font-bold text-gray-900">{formatPrice(props.price.current, props.price.currency)}</p>
      </div>
      <a
        href={buildAmazonLink(props.amazonAsin, props.affiliateTag)}
        target="_blank"
        rel="nofollow sponsored noopener"
        class="btn-amazon flex-shrink-0 px-5 py-3 text-sm"
      >
        Amazon →
      </a>
    </div>
  </div>
</BaseLayout>
