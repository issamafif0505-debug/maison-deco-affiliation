---
import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '../components/common/Breadcrumbs.astro';
import AmazonButton from '../components/product/AmazonButton.astro';
import RatingStars from '../components/product/RatingStars.astro';
import ProsCons from '../components/product/ProsCons.astro';
import { formatPrice } from '../utils/formatting';
import { productSchema } from '../utils/seo';
import { buildAmazonLink } from '../utils/affiliate';
import siteConfig from '../data/site-config.json';

interface Props {
  name: string;
  slug: string;
  shortDescription: string;
  fullDescription: string;
  category: string;
  amazonAsin: string;
  affiliateTag: string;
  price: { current: number; currency: string; lastChecked: string };
  rating: { score: number; count: number };
  image: string;
  pros: string[];
  cons: string[];
  specifications: { label: string; value: string }[];
  featured: boolean;
  inStock: boolean;
}

const props = Astro.props;

const breadcrumbs = [
  { label: 'Produits', href: '/produits/' },
  { label: props.name },
];

const schema = productSchema({
  name: props.name,
  description: props.shortDescription,
  image: props.image,
  price: props.price.current,
  currency: props.price.currency,
  rating: props.rating.score,
  ratingCount: props.rating.count,
  inStock: props.inStock,
  url: new URL(`/produits/${props.slug}/`, siteConfig.siteUrl).toString(),
});
---

<BaseLayout
  title={props.name}
  description={props.shortDescription}
  image={props.image}
  schema={schema}
>
  <div class="container-custom py-8 md:py-12">
    <Breadcrumbs items={breadcrumbs} />

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 mb-12">
      <!-- Product Image -->
      <div class="aspect-square bg-white rounded-2xl shadow-sm border border-gray-100 flex items-center justify-center p-8">
        <img
          src={props.image}
          alt={props.name}
          class="max-w-full max-h-full object-contain"
          loading="eager"
        />
      </div>

      <!-- Product Info -->
      <div class="flex flex-col justify-center">
        <div class="flex flex-wrap gap-2 mb-3">
          <span class="badge-category capitalize">{props.category}</span>
          {props.featured && <span class="badge bg-amber-100 text-amber-700">Coup de coeur</span>}
          {!props.inStock && <span class="badge bg-red-100 text-red-700">Indisponible</span>}
        </div>

        <h1 class="font-serif text-3xl md:text-4xl font-bold text-gray-900 mb-4">
          {props.name}
        </h1>

        <p class="text-gray-600 text-lg mb-6">{props.shortDescription}</p>

        <!-- Rating -->
        <div class="flex items-center gap-3 mb-6">
          <RatingStars score={props.rating.score} />
          <span class="text-sm text-gray-500">
            {props.rating.score}/5 ({props.rating.count.toLocaleString('fr-FR')} avis)
          </span>
        </div>

        <!-- Price -->
        <div class="mb-6">
          <span class="text-3xl font-bold text-gray-900">
            {formatPrice(props.price.current, props.price.currency)}
          </span>
          <p class="text-xs text-gray-400 mt-1">
            Prix constate le {props.price.lastChecked} - peut varier sur Amazon
          </p>
        </div>

        <!-- CTA -->
        <AmazonButton asin={props.amazonAsin} tag={props.affiliateTag} size="large" />

        <!-- Pros & Cons -->
        <div class="mt-8">
          <ProsCons pros={props.pros} cons={props.cons} />
        </div>
      </div>
    </div>

    <!-- Full Description -->
    <div class="max-w-3xl mx-auto mb-12">
      <h2 class="font-serif text-2xl font-bold text-gray-900 mb-4">Notre avis detaille</h2>
      <div class="prose-custom">
        <p>{props.fullDescription}</p>
      </div>
    </div>

    <!-- Specifications -->
    {props.specifications.length > 0 && (
      <div class="max-w-3xl mx-auto mb-12">
        <h2 class="font-serif text-2xl font-bold text-gray-900 mb-4">Caracteristiques techniques</h2>
        <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden">
          <table class="w-full">
            <tbody>
              {props.specifications.map((spec, index) => (
                <tr class:list={[index % 2 === 0 ? 'bg-gray-50' : 'bg-white']}>
                  <td class="px-6 py-3 text-sm font-medium text-gray-700 w-1/3">{spec.label}</td>
                  <td class="px-6 py-3 text-sm text-gray-600">{spec.value}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    )}

    <!-- Bottom CTA -->
    <div class="max-w-3xl mx-auto text-center p-8 bg-amber-50 rounded-2xl border border-amber-100">
      <h3 class="font-serif text-xl font-bold text-gray-900 mb-2">Interesse(e) par ce produit ?</h3>
      <p class="text-gray-600 mb-4">Consultez le prix actuel et les avis sur Amazon</p>
      <AmazonButton asin={props.amazonAsin} tag={props.affiliateTag} size="large" />
    </div>
  </div>
</BaseLayout>
