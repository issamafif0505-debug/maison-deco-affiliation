---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProductCard from '../../components/product/ProductCard.astro';
import Breadcrumbs from '../../components/common/Breadcrumbs.astro';
import { getCollection } from 'astro:content';

const allProducts = await getCollection('products');
const sortedProducts = allProducts.sort((a, b) => {
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  return b.data.rating.score - a.data.rating.score;
});

const uniqueCategories = [...new Set(sortedProducts.map(p => p.data.category))].sort();
---

<BaseLayout
  title="Tous les produits s√©lectionn√©s ‚Äî Maison & D√©co"
  description="35+ produits maison et d√©coration test√©s et approuv√©s par Issam. Images r√©elles, avis honn√™tes, prix Amazon v√©rifi√©s."
>
  <div class="container-custom py-8 md:py-12">
    <Breadcrumbs items={[{ label: 'Produits' }]} />

    <!-- En-t√™te -->
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-8">
      <div>
        <h1 class="font-serif text-4xl md:text-5xl font-bold text-gray-900 mb-3">
          Nos produits s√©lectionn√©s
        </h1>
        <p class="text-lg text-gray-600 max-w-2xl">
          <strong>{sortedProducts.length} produits</strong> test√©s & approuv√©s ‚Äî avis honn√™tes, prix Amazon v√©rifi√©s.
        </p>
      </div>
      <div class="flex items-center gap-2 bg-green-50 border border-green-200 rounded-xl px-4 py-3 flex-shrink-0">
        <span class="text-2xl">‚≠ê</span>
        <div>
          <p class="text-sm font-bold text-green-800">Tous not√©s 4+ / 5</p>
          <p class="text-xs text-green-600">S√©lection Amazon.fr</p>
        </div>
      </div>
    </div>

    <!-- Filtres par cat√©gorie -->
    <div class="mb-8 flex flex-wrap gap-2" id="category-filters">
      <button
        class="filter-btn active px-4 py-2 rounded-full text-sm font-semibold border-2 transition-all duration-200"
        data-category="all"
      >
        Tout ({sortedProducts.length})
      </button>
      {uniqueCategories.map((cat) => {
        const count = sortedProducts.filter(p => p.data.category === cat).length;
        return (
          <button
            class="filter-btn px-4 py-2 rounded-full text-sm font-semibold border-2 transition-all duration-200 capitalize"
            data-category={cat}
          >
            {cat} ({count})
          </button>
        );
      })}
    </div>

    <!-- Grille produits -->
    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      {sortedProducts.map((product) => (
        <div class="product-item h-full" data-category={product.data.category}>
          <ProductCard
            name={product.data.name}
            slug={product.data.slug}
            shortDescription={product.data.shortDescription}
            image={product.data.image}
            category={product.data.category}
            amazonAsin={product.data.amazonAsin}
            affiliateTag={product.data.affiliateTag}
            price={product.data.price}
            rating={product.data.rating}
            featured={product.data.featured}
            inStock={product.data.inStock}
          />
        </div>
      ))}
    </div>

    <!-- Aucun r√©sultat -->
    <div id="no-results" class="hidden text-center py-20">
      <span class="text-5xl mb-4 block">üîç</span>
      <p class="text-gray-600 text-lg">Aucun produit dans cette cat√©gorie pour l'instant.</p>
    </div>

    <!-- Disclaimer affili√© -->
    <p class="text-xs text-gray-400 text-center mt-12 max-w-2xl mx-auto">
      En tant que Partenaire Amazon, je per√ßois une commission sur les achats qualifi√©s. Les prix peuvent varier ‚Äî consultez Amazon.fr pour le prix actuel.
    </p>
  </div>
</BaseLayout>

<style>
  .filter-btn {
    background: white;
    border-color: #e5e7eb;
    color: #6b7280;
    cursor: pointer;
  }
  .filter-btn:hover {
    border-color: #f97316;
    color: #f97316;
  }
  .filter-btn.active {
    background: #f97316;
    border-color: #f97316;
    color: white;
  }
  .product-item {
    display: flex;
    flex-direction: column;
  }
  .product-item > article {
    flex: 1;
  }
</style>

<script>
  const buttons = document.querySelectorAll<HTMLButtonElement>('.filter-btn');
  const items = document.querySelectorAll<HTMLElement>('.product-item');
  const noResults = document.getElementById('no-results');

  buttons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const cat = btn.dataset.category ?? 'all';

      buttons.forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');

      let visible = 0;
      items.forEach((item) => {
        const show = cat === 'all' || item.dataset.category === cat;
        item.style.display = show ? '' : 'none';
        if (show) visible++;
      });

      if (noResults) {
        noResults.classList.toggle('hidden', visible > 0);
      }
    });
  });
</script>
